<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/header :: head}"></head>
<link rel="stylesheet" th:href="@{/webjars/select2/4.0.13/css/select2.min.css}" />
<link rel="stylesheet" th:href="@{/webjars/jquery-ui/jquery-ui.min.css}" />

<body>
    <div th:replace="~{fragments/header :: header}"></div>

    <div class="container mt-5 mb-5 fade-in">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="card-title mb-4 text-center"
                th:text="${purchaseOrder.id != null} ? 'Edit Purchase Order' : 'New Purchase Order'">
                Purchase Order Form</h2>
        </div>
        <div class="card shadow-sm">
            <div class="card-body">
                <div th:replace="~{fragments/message :: message}"></div>
                <form th:action="@{/purchase-order/save}" th:object="${purchaseOrder}" method="post"
                    class="needs-validation" novalidate>
                    <input type="hidden" th:field="*{id}" />

                    <div class="row g-3 mb-3">
                        <div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
                            <label for="supplier">Supplier</label>
                            <select class="form-select" id="supplier" th:field="*{supplierId}"
                                th:classappend="${#fields.hasErrors('supplierId')} ? 'is-invalid'" required>
                                <option value="" disabled>Select Supplier</option>
                                <option th:each="supplier : ${suppliers}" th:value="${supplier.id}"
                                    th:text="${supplier.supplierName}"></option>
                            </select>
                            <div class="text-danger" th:if="${#fields.hasErrors('supplierId')}"
                                th:errors="*{supplierId}"></div>
                        </div>
                        <div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
                            <label for="purchaseDate">Purchase Date</label>
                            <input type="text" class="form-control datepicker" id="purchaseDate"
                                th:field="*{purchaseDate}" placeholder="Enter purchase date"
                                th:classappend="${#fields.hasErrors('purchaseDate')} ? 'is-invalid'" required />
                            <div class="text-danger" th:if="${#fields.hasErrors('purchaseDate')}"
                                th:errors="*{purchaseDate}"></div>
                        </div>
                        <div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
                            <label for="orderNumber">Order / Bill Number</label>
                            <input type="text" class="form-control" id="orderNumber" th:field="*{orderNumber}"
                                placeholder="Enter Order number"
                                th:classappend="${#fields.hasErrors('orderNumber')} ? 'is-invalid'" required />
                            <div class="text-danger" th:if="${#fields.hasErrors('orderNumber')}"
                                th:errors="*{orderNumber}"></div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
                        <h5 class="mb-0">Purchase Items</h5>
                        <button type="button" id="add-item" class="btn btn-secondary btn-sm">
                            <i class="bi bi-plus-circle"></i>
                            <span class="ms-1">Add Item</span>
                        </button>
                    </div>

                    <div id="items-container">
                        <div th:each="item, iterStat : *{items}" class="card mb-3 item-entry border">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong th:text="'Item #' + ${iterStat.index + 1}">Item #1</strong>
                                    <button type="button" class="btn btn-danger btn-sm remove-item">
                                        <i class="bi bi-trash-fill"></i> Delete Item
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <input type="hidden" th:field="*{items[__${iterStat.index}__].id}" />
                                    <div class="col-md-3">
                                        <label>Product</label>
                                        <select class="form-select product-select"
                                            th:field="*{items[__${iterStat.index}__].productId}" required>
                                            <option value="" disabled>Select Product</option>
                                            <option th:each="product : ${products}" th:value="${product.id}"
                                                th:text="${product.productName}"></option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label>Quantity</label>
                                        <input type="number" class="form-control"
                                            th:field="*{items[__${iterStat.index}__].quantity}" required />
                                    </div>
                                    <div class="col-md-3">
                                        <label>Price/Unit</label>
                                        <input type="number" step="0.01" class="form-control"
                                            th:field="*{items[__${iterStat.index}__].pricePerUnit}" required />
                                    </div>
                                    <div class="col-md-3">
                                        <label>Expiry Date</label>
                                        <input type="text" class="form-control expiryDate"
                                            th:field="*{items[__${iterStat.index}__].expiryDate}" required />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-center mt-4">
                        <button type="submit" class="btn btn-primary px-4">Save Purchase Order</button>
                    </div>
                </form>

                <div class="mt-3 text-center">
                    <a th:href="@{/purchase-order/purchase-order-list}" class="btn btn-link">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- Hidden template for new item rows -->
    <div id="item-template" class="d-none">
        <div class="card mb-3 item-entry border">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <strong class="item-title">Item #__index__</strong>
                    <button type="button" class="btn btn-danger remove-item btn-sm">
                        <i class="bi bi-trash-fill"></i>
                        <span class="ms-1">Delete Item</span>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label>Product</label>
                            <select class="form-select product-select" name="items[0].productId" required>
                                <option value="" disabled selected>Select Product</option>
                                <option th:each="product : ${products}" th:value="${product.id}"
                                    th:text="${product.productName}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label>Quantity</label>
                        <input type="number" class="form-control" name="items[__index__].quantity"
                            placeholder="Quantity" required />
                    </div>
                    <div class="col-md-3">
                        <label>Price/Unit</label>
                        <input type="number" step="0.01" class="form-control" name="items[__index__].pricePerUnit"
                            placeholder="Price/Unit" required />
                    </div>
                    <div class="col-md-3">
                        <label>Expiry Date</label>
                        <input type="text" class="form-control expiryDate" name="items[__index__].expiryDate"
                            placeholder="Expiry Date" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="text/javascript" th:src="@{/webjars/bootstrap/js/bootstrap.min.js}"></script>
    <script type="text/javascript" th:src="@{/webjars/jquery/jquery.min.js}"></script>
    <script th:src="@{/webjars/jquery-ui/jquery-ui.min.js}"></script>
    <script th:src="@{/webjars/select2/4.0.13/js/select2.min.js}"></script>
    <script th:src="@{/js/purchase-order.js}"></script>
</body>

</html>